#!KAMAILIO
#
# Scenario 03 â€” Stateful Proxy with Record-Route
#
# Same as kamailio.cfg but adds Record-Route support:
# - record_route() inserts this proxy into the dialog path
# - loose_route() handles in-dialog requests (ACK, BYE)
#
# Compare pcap with and without --record-route:
# - Without: ACK/BYE go directly UAC -> UAS
# - With:    ACK/BYE go through this proxy via Route headers
# Plus you still see 100 Trying from the TM module.

debug=2
log_stderror=yes
fork=yes
children=2
auto_aliases=no

listen=udp:172.20.0.10:5060

mpath="/usr/lib/kamailio/modules/"

loadmodule "sl.so"
loadmodule "maxfwd.so"
loadmodule "pv.so"
loadmodule "tm.so"
loadmodule "rr.so"
loadmodule "siputils.so"

# Auto-generate 100 Trying for INVITE transactions
modparam("tm", "auto_inv_100", 1)
# Add ;lr parameter to Record-Route URI (loose routing)
modparam("rr", "enable_full_lr", 1)

request_route {
    # Max-Forwards check: prevent loops
    if (!maxfwd_process("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # In-dialog requests: ACK, BYE, re-INVITE (have a To-tag)
    if (has_totag()) {
        if (loose_route()) {
            t_relay();
            exit;
        }
    }

    # Initial requests: add Record-Route so we stay in the dialog
    record_route();

    # Stateful relay: creates a transaction, sends 100 Trying for INVITEs
    t_relay();
}
