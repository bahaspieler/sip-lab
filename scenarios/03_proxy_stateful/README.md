# Scenario 03 — Stateful Proxy

## Topology

```
UAC (172.20.0.2) ──► Kamailio Proxy (172.20.0.10) ──► UAS (172.20.0.3)
                          ▲
                       capture
```

Same topology as scenario 02, but Kamailio uses `t_relay()` (transaction module)
instead of `forward()`.

## Concepts

| Concept | Description |
|---------|-------------|
| **Stateful proxy** | Maintains transaction state using Kamailio's `tm` module. Tracks INVITE and its responses as a single transaction. |
| **100 Trying** | Auto-generated by the proxy for INVITE transactions — tells the UAC "I received your request, working on it." |
| **Transaction** | An INVITE, its provisional responses (1xx), final response (2xx/3xx/4xx/5xx/6xx), and ACK form one transaction. |

## How to Run

```bash
python3 labctl.py run 03_proxy_stateful
```

## What to Look for in the PCAP

Open `captures/03_proxy_stateful.pcap` in Wireshark or tshark.

### 1. 100 Trying from the Proxy

The key difference from scenario 02:

```bash
# Find 100 Trying — notice it comes FROM the proxy (.10) TO the UAC (.2)
tshark -r captures/03_proxy_stateful.pcap -Y "sip.Status-Code==100" -T fields -e ip.src -e ip.dst -e sip.Status-Code -e sip.Status-Line
```

### 2. Both Legs Visible

Since capture is on the proxy namespace, you see every packet twice —
once on the UAC↔Proxy leg, once on the Proxy↔UAS leg:

```bash
tshark -r captures/03_proxy_stateful.pcap -Y sip -T fields -e frame.number -e ip.src -e ip.dst -e sip.Method -e sip.Status-Code
```

Expected flow (12 packets):

| # | From | To | Message |
|---|------|-----|---------|
| 1 | UAC (.2) | Proxy (.10) | INVITE |
| 2 | Proxy (.10) | UAC (.2) | **100 Trying** |
| 3 | Proxy (.10) | UAS (.3) | INVITE |
| 4 | UAS (.3) | Proxy (.10) | 180 Ringing |
| 5 | UAS (.3) | Proxy (.10) | 200 OK |
| 6 | Proxy (.10) | UAC (.2) | 200 OK |
| 7 | UAC (.2) | Proxy (.10) | ACK |
| 8 | Proxy (.10) | UAS (.3) | ACK |
| 9 | UAC (.2) | Proxy (.10) | BYE |
| 10 | Proxy (.10) | UAS (.3) | BYE |
| 11 | UAS (.3) | Proxy (.10) | 200 OK (BYE) |
| 12 | Proxy (.10) | UAC (.2) | 200 OK (BYE) |

### 3. Via Header Comparison

```bash
# INVITE from UAC→Proxy: 1 Via (UAC only)
tshark -r captures/03_proxy_stateful.pcap -Y "sip.Method==INVITE && ip.src==172.20.0.2" -T fields -e sip.Via

# INVITE from Proxy→UAS: 2 Via (Proxy + UAC)
tshark -r captures/03_proxy_stateful.pcap -Y "sip.Method==INVITE && ip.src==172.20.0.10 && ip.dst==172.20.0.3" -T fields -e sip.Via
```

## Key Kamailio Config

```
loadmodule "tm.so"
modparam("tm", "auto_inv_100", 1)    # ← auto-generate 100 Trying

request_route {
    if (!maxfwd_process("10")) { sl_send_reply("483", "Too Many Hops"); exit; }
    t_relay();   # Stateful: creates transaction, sends 100 Trying
}
```

## Exercises

1. Compare this pcap with scenario 02: which packet is present here but absent there?
2. Who generates the 100 Trying — the proxy or the UAS? How can you tell from the IP addresses?
3. What happens if the UAS takes 10 seconds to respond? Why is 100 Trying important?
4. Does the 180 Ringing arrive before or after the 200 OK? Compare with scenario 02.
