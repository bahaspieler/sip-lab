#!KAMAILIO
#
# Scenario 03 â€” Stateful Proxy (Transaction Module)
#
# Uses t_relay() instead of forward(). The TM module:
# - Tracks transactions (INVITE + responses as one unit)
# - Automatically generates 100 Trying for INVITE transactions
# - Handles retransmissions
#
# Compare pcap with scenario 02: you will see an extra 100 Trying
# generated by this proxy that the stateless proxy did NOT produce.

debug=2
log_stderror=yes
fork=yes
children=2
auto_aliases=no

listen=udp:172.20.0.10:5060

mpath="/usr/lib/kamailio/modules/"

loadmodule "sl.so"
loadmodule "maxfwd.so"
loadmodule "pv.so"
loadmodule "tm.so"

# Auto-generate 100 Trying for INVITE transactions
modparam("tm", "auto_inv_100", 1)

request_route {
    # Max-Forwards check: prevent loops
    if (!maxfwd_process("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # Stateful relay: creates a transaction, sends 100 Trying for INVITEs
    t_relay();
}
