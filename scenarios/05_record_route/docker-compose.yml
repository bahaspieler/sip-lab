# Scenario 05 â€” Record-Route and Route Headers
#
# Topology:  UAC (.2) --> Proxy1 (.10) --> Proxy2 (.11) --> UAS (.3)
#            capture (shares UAS network namespace)
#
# Same topology as scenario 04, but both proxies add Record-Route.
# This means ACK and BYE will have Route headers and traverse the
# same proxy path as the INVITE. Compare with scenario 04 to see
# the difference.

services:
  sipp_uac:
    image: ctaloi/sipp:latest
    platform: linux/amd64
    container_name: sipp_uac
    entrypoint: ["/bin/sh", "-lc"]
    command: ["while true; do sleep 3600; done"]
    networks:
      sipnet:
        ipv4_address: 172.20.0.2
    volumes:
      - ../../sipp:/sipp:ro

  sipp_uas:
    image: ctaloi/sipp:latest
    platform: linux/amd64
    container_name: sipp_uas
    entrypoint: ["/bin/sh", "-lc"]
    command: ["while true; do sleep 3600; done"]
    networks:
      sipnet:
        ipv4_address: 172.20.0.3
    volumes:
      - ../../sipp:/sipp:ro

  proxy1:
    image: kamailio/kamailio-ci:latest
    platform: linux/amd64
    container_name: proxy1
    volumes:
      - ./proxy1.cfg:/etc/kamailio/kamailio.cfg:ro
    networks:
      sipnet:
        ipv4_address: 172.20.0.10

  proxy2:
    image: kamailio/kamailio-ci:latest
    platform: linux/amd64
    container_name: proxy2
    volumes:
      - ./proxy2.cfg:/etc/kamailio/kamailio.cfg:ro
    networks:
      sipnet:
        ipv4_address: 172.20.0.11

  capture:
    image: nicolaka/netshoot:latest
    container_name: capture
    command: ["sleep", "infinity"]
    cap_add: ["NET_ADMIN", "NET_RAW"]
    # Capture on proxy2's namespace to see Record-Route/Route headers
    # and Via stacking on both incoming and outgoing legs.
    network_mode: "service:proxy2"
    volumes:
      - ../../captures:/captures

networks:
  sipnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
