#!KAMAILIO
#
# Scenario 04 â€” Proxy Chain: Proxy1
#
# Receives requests from UAC and forwards to Proxy2.
# Uses $du to override the next-hop destination WITHOUT changing the Request-URI.
# This is the standard way a proxy routes through another proxy.

debug=2
log_stderror=yes
fork=yes
children=2
auto_aliases=no

listen=udp:172.20.0.10:5060

mpath="/usr/lib/kamailio/modules/"

loadmodule "sl.so"
loadmodule "maxfwd.so"
loadmodule "pv.so"
loadmodule "tm.so"

modparam("tm", "auto_inv_100", 1)

request_route {
    if (!maxfwd_process("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # Override destination URI to send to proxy2 (next hop)
    # The Request-URI stays unchanged (still points to UAS)
    $du = "sip:172.20.0.11:5060";

    t_relay();
}
